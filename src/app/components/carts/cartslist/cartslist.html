<div class="container my-4">
  <h2 class="text-center mb-4">Shopping Cart</h2>

  <div>
    <div class="d-flex mb-3">
      <button class="btn btn-outline-secondary" (click)="goToHome()">
        <i class="fas fa-arrow-left"></i> Continue Shopping
      </button>
    </div>
    <div class="d-flex mb-3 justify-content-end">
      <button class="btn btn-danger" (click)="clearCart()">üóëÔ∏è Limpar Carrinho</button>
    </div>
  </div>

  <!-- Estado de carregamento -->
  @if (isLoading) {
  <div class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  }

  <!-- Carrinho vazio -->
  @if (!isLoading && (!cart || !cart.items || cart.items.length === 0)) {
  <div class="alert alert-info text-center">Your cart is empty. Add some cars to continue!</div>
  }

  <!-- Tabela de itens -->
  @if (!isLoading && cart && cart.items && cart.items.length > 0) {
  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Car</th>
        <th>Price</th>
        <th>Accessories</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for (item of cart.items; track item.id) {
      <tr>
        <td>{{ item.id }}</td>
        <td>
          <strong>{{ item.car.name }}</strong
          ><br />
          <small class="text-muted">{{ item.car.brand.name }}</small>
        </td>
        <td>{{ item.car.price | currency : 'USD' }}</td>

        <td>
          @if (item.chosenAccessories && item.chosenAccessories.length > 0) {
          <ul class="list-unstyled mb-0">
            @for (acc of item.chosenAccessories; track acc.id) {
            <li>{{ acc.name }} (+{{ acc.price | currency : 'USD' }})</li>
            }
          </ul>
          } @else {
          <span class="text-muted">No accessories</span>
          }
        </td>

        <td>
          {{ getTotalPrice(item) | currency : 'USD' }}
        </td>

        <td>
          <button class="btn btn-sm btn-primary me-2" (click)="editAccessories(item)">
            <i class="fas fa-edit"></i> Edit
          </button>

          <button class="btn btn-sm btn-danger" (click)="removeItem(item)">
            <i class="fas fa-trash"></i> Remove
          </button>
        </td>
      </tr>
      }
    </tbody>
    <tfoot class="table-light">
      <tr>
        <td colspan="4" class="text-end fw-bold fs-5 align-middle">Total:</td>

        <td class="fw-bold fs-5 text-success align-middle">
          {{ getGrandTotal() | currency : 'USD' }}
        </td>

        <td></td>
      </tr>
    </tfoot>
  </table>

  <div class="text-end mt-4">
    <button class="btn btn-success btn-lg" (click)="goToCheckout()">
      <i class="fas fa-credit-card"></i> Proceed to Checkout
    </button>
  </div>

  }
</div>
<ng-template #modalEditAccessories>
  <div class="modal-header">
    @if (editingItem?.car) {
    <h5 class="modal-title">Edit Accessories ‚Äî {{ editingItem.car.name }}</h5>
    }
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>

  <div class="modal-body">
    @if (editingItem?.car) {
    <p>
      Base Price:
      <strong>{{ editingItem.car.price | currency : 'USD' }}</strong>
    </p>

    <p><strong>Available Accessories:</strong></p>

    @if (editingItem.car.acessories && editingItem.car.acessories.length > 0) {
    <ul class="list-group">
      @for (acc of editingItem.car.acessories; track acc.id) {
      <li class="list-group-item">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [checked]="isAccessorySelected(acc.id)"
            (change)="toggleAccessorySelection(acc, $any($event.target).checked)"
          />
          <label class="form-check-label">
            {{ acc.name }}
            <span class="text-muted">(+{{ acc.price | currency : 'USD' }})</span>
          </label>
        </div>
      </li>
      }
    </ul>
    } @else {
    <div class="alert alert-info">This car has no available accessories.</div>
    } }
  </div>

  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
    <button class="btn btn-primary" (click)="saveAccessoryChanges()">Save</button>
  </div>
</ng-template>

<!-- <ng-template #modalCheckoutsdetails>
  <div class="modal-content">
    <app-checkoutsdetails (return)="returnCheckout()"></app-checkoutsdetails>
  </div>
</ng-template> -->

<ng-template #modalCheckoutsdetails>
  <div class="modal-header">
    <h5 class="modal-title">Finalizar Compra</h5>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>

  <div class="modal-body">
    <app-checkoutsdetails
      [modeModal]="true"
      [hiddenButtons]="false"
      (return)="returnCheckout()"
    ></app-checkoutsdetails>
  </div>
</ng-template>
